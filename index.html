<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ahorros y Gastos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p: #4f46e5; --i: #10b981; --e: #ef4444; --d: #f59e0b; --s: #06b6d4; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Login */
        #login-screen { position: fixed; inset: 0; background: var(--p); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .login-box { background: rgba(255,255,255,0.1); padding: 30px; border-radius: 25px; backdrop-filter: blur(10px); text-align: center; width: 85%; max-width: 350px; }
        .login-box input { width: 100%; padding: 15px; border-radius: 15px; border: none; margin: 20px 0; font-size: 1.5rem; text-align: center; letter-spacing: 10px; color: var(--p); }

        /* Loader */
        #loader { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top-color: var(--p); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        header { background: var(--p); color: white; padding: 25px 20px 45px; text-align: center; border-radius: 0 0 30px 30px; position: relative; }
        header h1 { font-size: 1.8rem; margin: 5px 0 0; font-weight: 800; }
        .nav-btn { position: absolute; top: 20px; background: rgba(255,255,255,0.15); border: none; color: white; padding: 10px; border-radius: 12px; font-size: 1.1rem; }

        /* Summary Cards */
        .summary-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; padding: 0 10px; margin-top: -25px; z-index: 5; }
        .stat-card { background: var(--card); padding: 10px 2px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid transparent; }
        .stat-card.active { border-color: var(--p); }
        .stat-card b { display: block; font-size: 0.55rem; color: #888; text-transform: uppercase; }
        .stat-card span { font-size: 0.75rem; font-weight: 800; }

        .category-bar { display: flex; gap: 8px; overflow-x: auto; padding: 15px 20px 5px; scrollbar-width: none; }
        .chip { background: white; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; color: #64748b; border: 1.5px solid #e2e8f0; white-space: nowrap; }
        .chip.active { background: var(--p); color: white; border-color: var(--p); }

        /* Info Banner */
        #category-total-banner { margin: 0 20px 10px; padding: 15px; background: white; border-radius: 15px; display: none; flex-direction: column; border: 1.5px dashed var(--p); }
        .banner-row { display: flex; justify-content: space-between; align-items: center; margin: 3px 0; font-size: 0.85rem; }

        /* Feed */
        .main-feed { flex: 1; overflow-y: auto; padding: 0 20px 100px; }
        .item-card { background: var(--card); padding: 16px; border-radius: 18px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .item-info b { display: block; font-size: 0.95rem; }
        .tag { display: inline-block; font-size: 0.6rem; background: #f1f5f9; padding: 2px 6px; border-radius: 5px; font-weight: bold; margin-top: 4px; color: #64748b; }
        .source-tag { background: #e0e7ff; color: var(--p); border: 1px solid #c7d2fe; }
        .save-tag { background: #cffafe; color: var(--s); border: 1px solid #a5f3fc; }

        .plus-txt { color: var(--i); } .minus-txt { color: var(--e); } .debt-txt { color: var(--d); } .save-txt { color: var(--s); }

        /* Botones */
        .actions { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 12px; z-index: 50; }
        .btn-fab { width: 60px; height: 60px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-end; z-index: 100; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 100%; padding: 25px; border-radius: 30px 30px 0 0; max-height: 85vh; overflow-y: auto; }
        input, select, .btn-full { width: 100%; padding: 16px; margin-bottom: 10px; border-radius: 15px; border: 1px solid #e2e8f0; font-size: 1rem; }
        .btn-full { background: var(--p); color: white; border: none; font-weight: bold; }
        .cat-item { display: flex; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: 12px; margin-bottom: 8px; align-items: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <i class="fa-solid fa-vault" style="font-size: 3rem; margin-bottom: 10px;"></i>
            <h3>Control Financiero</h3>
            <input type="password" id="pin-input" inputmode="numeric" placeholder="****" maxlength="4">
            <button class="btn-full" onclick="checkLogin()" style="background: var(--i);">Desbloquear</button>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div><p>Sincronizando...</p></div>

    <header>
        <button class="nav-btn" style="left:20px" onclick="openModal('modal-history')"><i class="fa-solid fa-clock-rotate-left"></i></button>
        <button class="nav-btn" style="right:20px" onclick="openModal('modal-archive')"><i class="fa-solid fa-box-archive"></i></button>
        <span style="font-size:0.7rem; opacity:0.8;">DISPONIBLE TOTAL</span>
        <h1 id="balance-display">$0</h1>
    </header>

    <div class="summary-grid">
        <div class="stat-card" id="card-plus" onclick="setFilter('plus')"><b>Ingresos</b><span id="total-inc" class="plus-txt">$0</span></div>
        <div class="stat-card" id="card-minus" onclick="setFilter('minus')"><b>Gastos</b><span id="total-exp" class="minus-txt">$0</span></div>
        <div class="stat-card" id="card-debt" onclick="setFilter('debt')"><b>Deudas</b><span id="total-deb" class="debt-txt">$0</span></div>
        <div class="stat-card" id="card-save" onclick="setFilter('save')"><b>Ahorros</b><span id="total-sav" class="save-txt">$0</span></div>
    </div>

    <div id="filter-container" class="category-bar"></div>

    <div id="category-total-banner">
        <div class="banner-row" style="border-bottom: 1px solid #eee; padding-bottom: 5px;">
            <span id="cat-label" style="font-weight:bold">Categoría</span> 
            <span id="cat-remaining">$0</span>
        </div>
        <div class="banner-row"><span style="color:#64748b">Ingresado:</span> <span id="cat-earned">$0</span></div>
        <div class="banner-row"><span style="color:#64748b">Gastado:</span> <span id="cat-spent">$0</span></div>
        <div class="banner-row"><span style="color:#64748b">Ahorrado:</span> <span id="cat-saved-from">$0</span></div>
    </div>

    <div class="main-feed"><div id="transaction-list"></div></div>

    <div class="actions">
        <button class="btn-fab" style="background:white; color:var(--p)" onclick="openModal('modal-cat')"><i class="fa-solid fa-tags"></i></button>
        <button class="btn-fab" style="background:var(--p)" onclick="openModal('modal-add')"><i class="fa-solid fa-plus"></i></button>
    </div>

    <!-- MODAL REGISTRO -->
    <div class="modal" id="modal-add" onclick="closeModal('modal-add')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Nuevo Registro</h3>
            <form id="tx-form">
                <input type="text" id="tx-text" placeholder="Concepto" required>
                <input type="text" inputmode="numeric" id="tx-amount" placeholder="Monto" required>
                <select id="tx-type" onchange="refreshFormCats()">
                    <option value="plus">Ingreso (+)</option>
                    <option value="minus">Gasto (-)</option>
                    <option value="save">Ahorro (Hacia hucha)</option>
                    <option value="debt">Deuda (Debo)</option>
                </select>
                <div id="cat-group">
                    <label id="cat-label-form" style="font-size:0.7rem">Categoría:</label>
                    <select id="tx-category"></select>
                </div>
                <div id="source-group" style="display:none">
                    <label style="font-size:0.7rem; color:var(--p)">¿De qué ingreso sale el dinero?</label>
                    <select id="tx-source"></select>
                </div>
                <button type="submit" class="btn-full">Guardar Movimiento</button>
            </form>
        </div>
    </div>

    <!-- MODAL PAGAR DEUDA -->
    <div class="modal" id="modal-pay-debt" onclick="closeModal('modal-pay-debt')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Pagar Deuda</h3>
            <p id="pay-debt-info" style="font-size:0.9rem"></p>
            <label style="font-size:0.7rem">Origen del dinero:</label>
            <select id="pay-debt-source"></select>
            <button class="btn-full" onclick="executePayDebt()" style="background:var(--i); margin-top:10px">Confirmar Pago</button>
        </div>
    </div>

    <!-- MODAL CATEGORÍAS -->
    <div class="modal" id="modal-cat" onclick="closeModal('modal-cat')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Gestionar Categorías</h3>
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <input type="text" id="new-cat-name" placeholder="Nombre..." style="margin:0">
                <select id="new-cat-type" style="width:110px; margin:0">
                    <option value="inc">Ingreso</option>
                    <option value="exp">Gasto</option>
                    <option value="sav">Ahorro</option>
                </select>
                <button onclick="addCat()" style="background:var(--p); color:white; border:none; padding:10px 15px; border-radius:12px">+</button>
            </div>
            <div id="cat-admin-list"></div>
            <button class="btn-full" style="background:#94a3b8; margin-top:15px" onclick="closeModal('modal-cat')">Cerrar</button>
        </div>
    </div>

    <div class="modal" id="modal-archive" onclick="closeModal('modal-archive')"><div class="modal-content" onclick="event.stopPropagation()"><h3>Cierre Mes</h3><button class="btn-full" onclick="processArchive()" style="background:var(--i)">Archivar</button></div></div>
    <div class="modal" id="modal-history" onclick="closeModal('modal-history')"><div class="modal-content" onclick="event.stopPropagation()"><h3>Historial</h3><div id="archives-list"></div></div></div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyr1dMKKAbqnnVvyGCTxYBhii5hmSR39zoSdURBYCYR_PTYK81QjwUQHjQtFLSucaNlpg/exec"; 
        const APP_PIN = "9874";

        let txs = [], debts = [], archives = [], catsInc = [], catsExp = [], catsSav = [];
        let filterType = 'all', filterCat = 'all', viewingArchive = null, debtToPay = null;

        const fmt = (n) => new Intl.NumberFormat('de-DE').format(Math.abs(n));

        function checkLogin() {
            if (document.getElementById('pin-input').value === APP_PIN) {
                document.getElementById('login-screen').style.display = 'none';
                sessionStorage.setItem('loggedIn', 'true');
                fetchFromGoogle();
            } else { alert("PIN Incorrecto"); }
        }
        if (sessionStorage.getItem('loggedIn') === 'true') { document.getElementById('login-screen').style.display = 'none'; fetchFromGoogle(); }

        async function fetchFromGoogle() {
            document.getElementById('loader').style.display = 'flex';
            try {
                const response = await fetch(WEB_APP_URL);
                const d = await response.json();
                txs = d.txs; debts = d.debts; archives = d.archives;
                catsInc = d.catsInc || []; catsExp = d.catsExp || []; catsSav = d.catsSav || ["Emergencia", "Viajes"];
                updateUI();
            } catch (e) { console.error(e); }
            document.getElementById('loader').style.display = 'none';
        }

        async function sync() {
            document.getElementById('loader').style.display = 'flex';
            const payload = { data: { txs, debts, archives, catsInc, catsExp, catsSav } };
            try { await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) }); setTimeout(updateUI, 800); } catch (e) { alert("Error"); }
            document.getElementById('loader').style.display = 'none';
        }

        function updateUI() {
            const list = document.getElementById('transaction-list');
            const banner = document.getElementById('category-total-banner');
            const data = viewingArchive || txs;
            list.innerHTML = '';
            
            document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            if(filterType !== 'all') document.getElementById('card-'+filterType).classList.add('active');

            const chips = document.getElementById('filter-container');
            chips.innerHTML = '';
            if(['plus','minus','save'].includes(filterType)){
                const src = filterType === 'plus' ? catsInc : (filterType === 'minus' ? catsExp : catsSav);
                chips.innerHTML = `<div class="chip ${filterCat==='all'?'active':''}" onclick="setCatFilter('all')">Todo</div>`;
                src.forEach(c => chips.innerHTML += `<div class="chip ${filterCat===c?'active':''}" onclick="setCatFilter('${c}')">${c}</div>`);
            }

            // Filtrado
            let filtered = [];
            if (filterType === 'debt') {
                filtered = debts.map(d=>({...d,isD:true}));
            } else if (filterType === 'plus' && filterCat !== 'all') {
                // Ver ingresos + lo que salió de ahí (gastos y ahorros)
                filtered = data.filter(t => (t.amount > 0 && t.cat === filterCat) || (t.source === filterCat));
            } else {
                filtered = data.filter(t => {
                    const mType = filterType==='all' || (filterType==='plus'?t.amount>0:(filterType==='save'?t.isSaving:t.amount<0 && !t.isSaving));
                    const mCat = filterCat==='all' || t.cat === filterCat || t.source === filterCat;
                    return mType && mCat;
                });
            }

            // Banner Totales
            if (filterCat !== 'all') {
                banner.style.display = 'flex';
                document.getElementById('cat-label').innerText = filterCat;
                const earned = data.filter(t => t.amount > 0 && t.cat === filterCat).reduce((a,b)=>a+b.amount,0);
                const spent = Math.abs(data.filter(t => t.amount < 0 && !t.isSaving && t.source === filterCat).reduce((a,b)=>a+b.amount,0));
                const saved = Math.abs(data.filter(t => t.isSaving && t.source === filterCat).reduce((a,b)=>a+b.amount,0));

                if (filterType === 'plus') {
                    document.getElementById('cat-earned').innerText = `$${fmt(earned)}`;
                    document.getElementById('cat-spent').innerText = `-$${fmt(spent)}`;
                    document.getElementById('cat-saved-from').innerText = `-$${fmt(saved)}`;
                    const rem = earned - spent - saved;
                    document.getElementById('cat-remaining').innerText = `$${fmt(rem)}`;
                    document.getElementById('cat-remaining').className = rem >= 0 ? 'plus-txt' : 'minus-txt';
                } else if (filterType === 'save') {
                    const totalInHucha = data.filter(t => t.isSaving && t.cat === filterCat).reduce((a,b)=>a+Math.abs(b.amount),0);
                    document.getElementById('cat-remaining').innerText = `$${fmt(totalInHucha)}`;
                    document.getElementById('cat-remaining').className = 'save-txt';
                    banner.querySelectorAll('.banner-row:not(:first-child)').forEach(r=>r.style.display='none');
                } else {
                    banner.querySelectorAll('.banner-row').forEach(r=>r.style.display='none');
                    banner.querySelector('.banner-row').style.display='flex';
                }
            } else { banner.style.display = 'none'; }

            filtered.sort((a,b) => b.id - a.id).forEach(t => {
                const div = document.createElement('div');
                div.className = 'item-card';
                div.innerHTML = `<div class="item-info">
                    <b>${t.text}</b><small>${t.date}</small><br>
                    <span class="tag ${t.isSaving?'save-tag':''}">${t.cat || ''}</span>
                    ${t.source ? `<span class="tag source-tag">← ${t.source}</span>` : ''}
                </div><div style="display:flex; align-items:center; gap:8px;">
                    ${t.isD && !viewingArchive ? `<button onclick="startPayDebt(${t.id})" style="background:var(--i); color:white; border:none; border-radius:8px; font-weight:800; font-size:0.65rem; padding:6px 10px">PAGAR</button>`:''}
                    <span class="amount ${t.isD?'debt-txt':(t.isSaving?'save-txt':(t.amount>0?'plus-txt':'minus-txt'))}">$${fmt(t.amount)}</span>
                    ${!viewingArchive ? `<i class="fa-solid fa-circle-xmark" style="color:#e2e8f0; font-size:1.3rem;" onclick="${t.isD?'delDb':'delTx'}(${t.id})"></i>`:''}
                </div>`;
                list.appendChild(div);
            });

            const ti = data.filter(t=>t.amount>0).reduce((a,b)=>a+b.amount,0);
            const te = Math.abs(data.filter(t=>t.amount<0 && !t.isSaving).reduce((a,b)=>a+b.amount,0));
            const ts = data.filter(t=>t.isSaving).reduce((a,b)=>a+Math.abs(b.amount),0);
            document.getElementById('balance-display').innerText = `$${fmt(ti-te-ts)}`;
            document.getElementById('total-inc').innerText = `+$${fmt(ti)}`;
            document.getElementById('total-exp').innerText = `-$${fmt(te)}`;
            document.getElementById('total-deb').innerText = `$${fmt(debts.reduce((a,b)=>a+b.amount,0))}`;
            document.getElementById('total-sav').innerText = `$${fmt(ts)}`;
            renderCatAdmin(); renderArchives();
        }

        function refreshFormCats() {
            const t = document.getElementById('tx-type').value;
            const catSel = document.getElementById('tx-category');
            const srcSel = document.getElementById('tx-source');
            const gCat = document.getElementById('cat-group');
            const gSrc = document.getElementById('source-group');
            const lCat = document.getElementById('cat-label-form');

            gCat.style.display = t==='debt'?'none':'block';
            gSrc.style.display = (t==='minus'||t==='save')?'block':'none';

            if(t==='plus'){ lCat.innerText="Categoría Ingreso:"; catSel.innerHTML=catsInc.map(c=>`<option value="${c}">${c}</option>`).join(''); }
            if(t==='minus'){ lCat.innerText="Categoría Gasto:"; catSel.innerHTML=catsExp.map(c=>`<option value="${c}">${c}</option>`).join(''); srcSel.innerHTML=catsInc.map(c=>`<option value="${c}">${c}</option>`).join(''); }
            if(t==='save'){ lCat.innerText="Hucha de Ahorro:"; catSel.innerHTML=catsSav.map(c=>`<option value="${c}">${c}</option>`).join(''); srcSel.innerHTML=catsInc.map(c=>`<option value="${c}">${c}</option>`).join(''); }
        }

        document.getElementById('tx-form').addEventListener('submit', e => {
            e.preventDefault();
            const val = parseInt(document.getElementById('tx-amount').value.replace(/\./g,''));
            const type = document.getElementById('tx-type').value;
            const item = { id:Date.now(), text:document.getElementById('tx-text').value, amount:val, date:new Date().toLocaleDateString('es-ES') };
            if(type==='debt') debts.push(item);
            else {
                item.cat = document.getElementById('tx-category').value;
                if(type==='save'){ item.amount = -val; item.isSaving = true; item.source = document.getElementById('tx-source').value; }
                if(type==='minus'){ item.amount = -val; item.source = document.getElementById('tx-source').value; }
                txs.push(item);
            }
            closeModal('modal-add'); sync();
        });

        function startPayDebt(id) {
            debtToPay = debts.find(x => x.id === id);
            document.getElementById('pay-debt-info').innerText = `Pagar: ${debtToPay.text} ($${fmt(debtToPay.amount)})`;
            document.getElementById('pay-debt-source').innerHTML = catsInc.map(c => `<option value="${c}">${c}</option>`).join('');
            openModal('modal-pay-debt');
        }

        function executePayDebt() {
            const src = document.getElementById('pay-debt-source').value;
            txs.push({ id:Date.now(), text:"PAGO DEUDA: "+debtToPay.text, amount:-debtToPay.amount, date:new Date().toLocaleDateString('es-ES'), cat:"Deuda", source:src });
            debts = debts.filter(x => x.id !== debtToPay.id);
            closeModal('modal-pay-debt'); sync();
        }

        function addCat() {
            const n = document.getElementById('new-cat-name').value.trim();
            const t = document.getElementById('new-cat-type').value;
            if(n) { if(t==='inc')catsInc.push(n); else if(t==='exp')catsExp.push(n); else catsSav.push(n); document.getElementById('new-cat-name').value=''; updateUI(); sync(); }
        }
        function moveCat(type, idx, dir) {
            const arr = type==='inc' ? catsInc : (type==='exp'?catsExp:catsSav);
            if(idx+dir >= 0 && idx+dir < arr.length){ [arr[idx], arr[idx+dir]] = [arr[idx+dir], arr[idx]]; updateUI(); sync(); }
        }
        function renderCatAdmin() {
            const draw = (arr, t) => arr.map((c,i)=>`<div class="cat-item"><span>${c}</span><div>
                <button onclick="moveCat('${t}',${i},-1)">↑</button><button onclick="moveCat('${t}',${i},1)">↓</button>
                <button onclick="${t==='inc'?'catsInc':(t==='exp'?'catsExp':'catsSav')}.splice(${i},1);sync()" style="color:var(--e); border:none; background:none; font-weight:bold; margin-left:5px">×</button></div></div>`).join('');
            document.getElementById('cat-admin-list').innerHTML = `<p style="color:var(--i); font-size:0.7rem; font-weight:bold;">INGRESOS</p>${draw(catsInc,'inc')}<p style="color:var(--e); font-size:0.7rem; font-weight:bold;">GASTOS</p>${draw(catsExp,'exp')}<p style="color:var(--s); font-size:0.7rem; font-weight:bold;">AHORROS</p>${draw(catsSav,'sav')}`;
        }

        function setCatFilter(c) { filterCat = c; updateUI(); }
        function setFilter(f) { filterType = (filterType===f)?'all':f; filterCat='all'; updateUI(); }
        function openModal(id) { document.getElementById(id).style.display='flex'; if(id==='modal-add') refreshFormCats(); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function delTx(id) { if(confirm("¿Eliminar?")){ txs=txs.filter(t=>t.id!==id); sync(); }}
        function delDb(id) { if(confirm("¿Eliminar?")){ debts=debts.filter(d=>d.id!==id); sync(); }}
        function renderArchives() { document.getElementById('archives-list').innerHTML = archives.map(a => `<div class="item-card" onclick="loadArch(${a.id})"><b>${a.period}</b></div>`).join(''); }
        function loadArch(id) { viewingArchive = archives.find(x=>x.id===id).data; document.getElementById('loader').style.display='none'; updateUI(); closeModal('modal-history'); }
        function exitArchiveMode() { viewingArchive = null; updateUI(); }
        function processArchive() { if(confirm("¿Archivar?")){ archives.push({id:Date.now(), period:txs[0].date+" al "+txs[txs.length-1].date, data:[...txs]}); txs=[]; sync(); closeModal('modal-archive'); } }
        document.getElementById('tx-amount').addEventListener('input',e=>{ let v = e.target.value.replace(/\D/g,""); e.target.value = v?fmt(v):""; });

        fetchFromGoogle();
    </script>
</body>
</html>